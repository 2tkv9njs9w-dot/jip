<!DOCTYPE html>
<html lang="lo">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ຮ້ານເຂົ້າປຽກຈິບໆ - ລະບົບຮັບອໍເດີ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Lao:wght@300;400;700&display=swap');
        body { font-family: 'Noto Sans Lao', sans-serif; background-color: #f1f5f9; }
        .hidden { display: none; }
        .menu-card:hover { transform: translateY(-5px); border-color: #f97316; }
        #toast {
            visibility: hidden; min-width: 250px; background-color: #1e293b; color: #fff;
            text-align: center; border-radius: 50px; padding: 16px; position: fixed;
            z-index: 100; left: 50%; bottom: 30px; transform: translateX(-50%); font-weight: bold;
        }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body>

    <div id="page-login" class="flex items-center justify-center min-h-screen bg-orange-600 p-4">
        <div class="bg-white p-10 rounded-[2.5rem] shadow-2xl w-full max-w-sm text-center">
            <div class="w-24 h-24 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-bowl-food text-orange-600 text-4xl"></i>
            </div>
            <h1 class="text-3xl font-black mb-1 text-slate-800 uppercase">ເຂົ້າປຽກຈິບໆ</h1>
            <p class="text-slate-400 mb-8 font-bold italic">ລະບົບຈັດການຮັບອໍເດີ</p>
            <div class="mb-6 relative">
                <input type="password" id="login-pass" placeholder="ໃສ່ລະຫັດ jip1234" class="w-full px-6 py-4 bg-slate-50 border rounded-2xl text-center text-xl outline-none focus:ring-2 ring-orange-500">
            </div>
            <button onclick="checkLogin()" class="w-full bg-orange-500 text-white py-4 rounded-2xl font-bold shadow-lg hover:bg-orange-600 transition-all active:scale-95">ເຂົ້າສູ່ລະບົບ</button>
        </div>
    </div>

    <div id="page-table" class="hidden min-h-screen p-6 md:p-10">
        <div class="max-w-7xl mx-auto">
            <header class="flex flex-col md:flex-row justify-between items-center mb-10 gap-6">
                <div>
                    <h1 class="text-4xl font-black text-slate-800">ຮ້ານເຂົ້າປຽກຈິບໆ</h1>
                    <p class="text-orange-500 font-bold uppercase tracking-widest text-sm">ເລືອກໂຕະເພື່ອຮັບອໍເດີ</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="showPage('page-report')" class="bg-white px-6 py-3 rounded-2xl font-bold shadow-sm border hover:bg-slate-50 transition-all"><i class="fas fa-file-invoice-dollar mr-2 text-emerald-500"></i>ຍອດຂາຍ</button>
                    <button onclick="showPage('page-admin')" class="bg-slate-800 text-white px-6 py-3 rounded-2xl font-bold shadow-lg hover:bg-slate-700 transition-all"><i class="fas fa-plus mr-2"></i>ເພີ່ມເມນູ</button>
                </div>
            </header>
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-6" id="table-grid"></div>
        </div>
    </div>

    <div id="page-pos" class="hidden h-screen flex flex-col overflow-hidden bg-slate-100">
        <header class="bg-white border-b p-4 flex justify-between items-center px-8 shadow-sm">
            <button onclick="showPage('page-table')" class="text-slate-500 font-bold flex items-center gap-2">
                <i class="fas fa-arrow-left"></i> ກັບຄືນ
            </button>
            <h2 id="pos-table-name" class="font-black text-2xl text-orange-600"></h2>
            <div class="w-20"></div>
        </header>
        
        <nav class="bg-white border-b flex justify-center gap-2 py-3">
            <button onclick="filterMenu('ທັງໝົດ')" class="category-btn px-8 py-2.5 rounded-xl font-bold bg-orange-500 text-white shadow-md">ທັງໝົດ</button>
            <button onclick="filterMenu('ອາຫານ')" class="category-btn px-8 py-2.5 rounded-xl font-bold text-slate-500">ອາຫານ</button>
            <button onclick="filterMenu('ເຄື່ອງດື່ມ')" class="category-btn px-8 py-2.5 rounded-xl font-bold text-slate-500">ເຄື່ອງດື່ມ</button>
        </nav>

        <main class="flex flex-1 overflow-hidden">
            <section class="w-2/3 p-6 overflow-y-auto grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 content-start" id="menu-list"></section>
            
            <aside class="w-1/3 bg-white border-l shadow-2xl flex flex-col">
                <div class="p-6 border-b flex justify-between items-center bg-slate-50">
                    <h2 class="font-black text-xl text-slate-800 uppercase italic">ລາຍການສັ່ງ</h2>
                    <i class="fas fa-shopping-cart text-slate-300"></i>
                </div>
                <div id="cart-items" class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50/50"></div>
                
                <div class="p-6 bg-white border-t shadow-inner space-y-4">
                    <div class="flex justify-between items-end">
                        <span class="text-slate-400 font-bold uppercase text-xs">ລວມເງິນທັງໝົດ</span>
                        <span id="total-price" class="text-4xl font-black text-orange-600">0</span>
                    </div>
                    <div class="grid grid-cols-2 gap-3 pt-2">
                        <button onclick="holdOrder()" class="bg-slate-200 text-slate-700 py-4 rounded-2xl font-bold hover:bg-slate-300">ພັກບິນ</button>
                        <button onclick="checkout()" class="bg-orange-500 text-white py-4 rounded-2xl font-bold shadow-lg text-lg active:scale-95">ໄລ່ເງິນ</button>
                    </div>
                </div>
            </aside>
        </main>
    </div>

    <div id="page-admin" class="hidden min-h-screen p-6 bg-slate-100 flex items-center justify-center">
        <div class="max-w-md w-full bg-white p-10 rounded-[2.5rem] shadow-xl border">
            <h2 class="text-2xl font-black mb-8 text-slate-800 border-b pb-4 italic text-center">ຕັ້ງຄ່າເມນູອາຫານ</h2>
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-400 ml-2">ຊື່ເມນູ (ຕົວຢ່າງ: ເຂົ້າປຽກ ໃຫຍ່)</label>
                    <input type="text" id="admin-name" placeholder="ຊື່ເມນູ" class="w-full p-4 bg-slate-50 rounded-2xl border outline-none focus:ring-2 ring-orange-500">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400 ml-2">ລາຄາ (ກີບ)</label>
                    <input type="number" id="admin-price" placeholder="ລາຄາ" class="w-full p-4 bg-slate-50 rounded-2xl border outline-none focus:ring-2 ring-orange-500">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400 ml-2">ໝວດໝູ່</label>
                    <select id="admin-category" class="w-full p-4 bg-slate-50 rounded-2xl font-bold border outline-none">
                        <option value="ອາຫານ">ອາຫານ</option>
                        <option value="ເຄື່ອງດື່ມ">ເຄື່ອງດື່ມ</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400 ml-2">ລິ້ງຮູບອາຫານ (Copy ມາຈາກ Google)</label>
                    <input type="text" id="admin-img-url" placeholder="ວາງລິ້ງຮູບຢູ່ບ່ອນນີ້" class="w-full p-4 bg-slate-50 rounded-2xl border outline-none text-sm">
                </div>
                <button onclick="handleSaveMenu()" class="w-full bg-orange-500 text-white py-4 rounded-2xl font-bold shadow-lg mt-4 active:scale-95 transition-all">ບັນທຶກເມນູໃໝ່</button>
                <button onclick="showPage('page-table')" class="w-full text-slate-400 font-bold py-2">ກັບຄືນ</button>
            </div>
            <div id="admin-display-list" class="mt-8 space-y-2 overflow-y-auto max-h-40 border-t pt-4"></div>
        </div>
    </div>

    <div id="page-report" class="hidden min-h-screen p-10 bg-slate-50">
        <div class="max-w-5xl mx-auto">
            <header class="flex justify-between items-center mb-10">
                <h2 class="text-4xl font-black italic text-slate-800">ລາຍງານການຂາຍ</h2>
                <button onclick="showPage('page-table')" class="bg-white px-6 py-3 rounded-2xl font-bold border">ກັບຄືນ</button>
            </header>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
                <div class="bg-slate-900 p-10 rounded-[2.5rem] text-white shadow-xl">
                    <p class="text-orange-400 text-xs font-bold uppercase mb-2">ຍອດຂາຍມື້ນີ້</p>
                    <h1 id="report-total-today" class="text-5xl font-black italic">0 KIP</h1>
                </div>
                <div class="bg-white p-10 rounded-[2.5rem] border shadow-sm"><p class="text-slate-400 text-xs font-bold mb-2">ບິນທັງໝົດ</p><h1 id="report-count-all" class="text-5xl font-black italic text-slate-800">0</h1></div>
            </div>
            <div id="report-daily-container" class="space-y-6"></div>
        </div>
    </div>

    <div id="toast">ສຳເລັດ!</div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDrkORCwmsdCsdpH81Y40kaDpgrHU-U6ps",
            authDomain: "khaopiakpos.firebaseapp.com",
            databaseURL: "https://khaopiakpos-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "khaopiakpos",
            storageBucket: "khaopiakpos.firebasestorage.app",
            messagingSenderId: "51654913004",
            appId: "1:51654913004:web:57eb6bc244c1918beaaec9",
            measurementId: "G-FYB29D6N9D"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let allMenus = [], cart = [], currentTable = "", activeOrders = {}, currentCategory = "ທັງໝົດ";

        function showPage(id) {
            document.querySelectorAll('body > div').forEach(div => div.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            if(id === 'page-table') listenToOrders();
            if(id === 'page-report') loadReports();
        }

        function checkLogin() {
            if(document.getElementById('login-pass').value === 'jip1234') showPage('page-table');
            else alert("ລະຫັດຜ່ານບໍ່ຖືກຕ້ອງ!");
        }

        function showToast(msg) {
            const x = document.getElementById("toast");
            x.innerText = msg; x.className = "show";
            setTimeout(() => { x.className = x.className.replace("show", ""); }, 2500);
        }

        // --- ຈັດການເມນູ ພ້ອມຮູບພາບ ---
        async function handleSaveMenu() {
            const name = document.getElementById('admin-name').value;
            const price = document.getElementById('admin-price').value;
            const category = document.getElementById('admin-category').value;
            const img = document.getElementById('admin-img-url').value;
            if (name && price) {
                const ref = db.ref('menus').push();
                await ref.set({ id: ref.key, name, price: Number(price), category, img: img || '' });
                showToast("ບັນທຶກເມນູສຳເລັດ");
                document.getElementById('admin-name').value = ""; document.getElementById('admin-price').value = ""; document.getElementById('admin-img-url').value = "";
            }
        }

        function loadMenus() {
            db.ref('menus').on('value', snap => {
                allMenus = snap.val() ? Object.values(snap.val()) : [];
                renderMenus(); renderAdminMenus();
            });
        }

        function renderMenus() {
            const filtered = allMenus.filter(m => currentCategory === "ທັງໝົດ" || m.category === currentCategory);
            document.getElementById('menu-list').innerHTML = filtered.map(m => `
                <div onclick="addToCart('${m.name}', ${m.price})" class="bg-white rounded-3xl shadow-md border-2 border-transparent menu-card cursor-pointer active:scale-95 transition-all overflow-hidden text-center">
                    <div class="w-full h-32 bg-slate-50 flex items-center justify-center overflow-hidden">
                        ${m.img ? `<img src="${m.img}" class="w-full h-full object-cover">` : `<i class="fas fa-image text-slate-200 text-3xl"></i>`}
                    </div>
                    <div class="p-4">
                        <div class="font-bold text-slate-800 truncate text-base">${m.name}</div>
                        <div class="text-orange-600 font-black mt-1 tracking-wider">${m.price.toLocaleString()}</div>
                    </div>
                </div>`).join('');
        }

        function addToCart(name, price) {
            const item = cart.find(c => c.name === name);
            if(item) item.qty++; else cart.push({ name, price, qty: 1 });
            renderCart();
        }

        function removeFromCart(idx) {
            cart.splice(idx, 1);
            renderCart();
        }

        function renderCart() {
            let total = 0;
            document.getElementById('cart-items').innerHTML = cart.map((item, idx) => {
                total += item.price * item.qty;
                return `
                <div class="flex justify-between items-center bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                    <div class="flex-1">
                        <p class="font-bold text-slate-800 text-sm leading-tight">${item.name}</p>
                        <p class="text-[10px] text-slate-400 font-bold mt-1 uppercase">${item.price.toLocaleString()} x ${item.qty}</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="font-black text-slate-800">${(item.price * item.qty).toLocaleString()}</span>
                        <button onclick="removeFromCart(${idx})" class="w-8 h-8 rounded-full bg-red-50 text-red-500 flex items-center justify-center hover:bg-red-500 hover:text-white transition-all">
                            <i class="fas fa-trash-alt text-[10px]"></i>
                        </button>
                    </div>
                </div>`;
            }).join('');
            document.getElementById('total-price').innerText = total.toLocaleString();
        }

        async function holdOrder() {
            if(cart.length === 0) return;
            await db.ref('activeOrders/' + currentTable).set({ items: cart, table: currentTable });
            showToast("ພັກບິນສຳເລັດ!");
            showPage('page-table');
        }

        async function checkout() {
            if(cart.length === 0) return;
            const total = cart.reduce((sum, i) => sum + (i.price * i.qty), 0);
            if(confirm(`ຢືນຢັນການຊຳລະ: ${total.toLocaleString()} KIP?`)) {
                await db.ref('sales').push({ table: currentTable, total: total, items: cart.map(i => `${i.name} (x${i.qty})`).join(', '), date: new Date().toLocaleDateString(), time: new Date().toLocaleTimeString(), timestamp: Date.now() });
                await db.ref('activeOrders/' + currentTable).remove();
                showToast("ໄລ່ເງິນສຳເລັດ!");
                showPage('page-table');
            }
        }

        function listenToOrders() { db.ref('activeOrders').on('value', snap => { activeOrders = snap.val() || {}; renderTables(); }); }
        
        function renderTables() {
            const grid = document.getElementById('table-grid'); grid.innerHTML = '';
            for(let i=1; i<=12; i++) {
                const tableName = `ໂຕະ ${i}`; const isActive = activeOrders[tableName];
                grid.innerHTML += `
                <div onclick="openPOS('${tableName}')" class="${isActive ? 'bg-orange-500 text-white shadow-orange-100 scale-105' : 'bg-white text-slate-800 hover:border-orange-500'} p-10 rounded-[2.5rem] shadow-md text-center font-black cursor-pointer transition-all border-2 border-transparent">
                    <p class="text-2xl italic">${tableName}</p>
                    <p class="text-[9px] uppercase mt-2 opacity-60 font-bold tracking-widest">${isActive ? 'ບໍ່ວ່າງ' : 'ວ່າງ'}</p>
                </div>`;
            }
        }

        function loadReports() {
            db.ref('sales').on('value', snap => {
                const container = document.getElementById('report-daily-container');
                const totalTodayDisplay = document.getElementById('report-total-today');
                const countDisplay = document.getElementById('report-count-all');
                container.innerHTML = '';
                if(!snap.val()) { totalTodayDisplay.innerText = "0 KIP"; countDisplay.innerText = "0"; return; }
                const sales = Object.entries(snap.val()).map(([id, val]) => ({ id, ...val }));
                sales.sort((a, b) => b.timestamp - a.timestamp);
                const todayDate = new Date().toLocaleDateString();
                let totalToday = 0;
                const grouped = sales.reduce((acc, sale) => {
                    const date = sale.date;
                    if(!acc[date]) acc[date] = { total: 0, items: [] };
                    acc[date].total += sale.total; acc[date].items.push(sale);
                    if(date === todayDate) totalToday += sale.total;
                    return acc;
                }, {});
                totalTodayDisplay.innerText = totalToday.toLocaleString() + " KIP";
                countDisplay.innerText = sales.length;
                Object.entries(grouped).forEach(([date, data]) => {
                    container.innerHTML += `
                    <div class="bg-white rounded-[2rem] shadow-sm border overflow-hidden">
                        <div class="bg-slate-900 p-5 flex justify-between items-center text-white">
                            <span class="font-bold">ວັນທີ: ${date}</span>
                            <span class="text-orange-400 font-black text-xl">${data.total.toLocaleString()} KIP</span>
                        </div>
                        <div class="divide-y">${data.items.map(s => `
                        <div class="p-6 flex justify-between items-center hover:bg-slate-50 transition-all">
                            <div class="flex-1">
                                <span class="bg-orange-100 text-orange-600 px-3 py-1 rounded-full text-[10px] font-black uppercase">${s.table}</span>
                                <p class="text-slate-600 text-sm mt-3 font-medium italic underline decoration-orange-100">${s.items}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-black text-slate-800 text-xl">${s.total.toLocaleString()}</p>
                                <button onclick="deleteSale('${s.id}')" class="text-slate-300 hover:text-red-500 text-[10px] font-bold mt-2 uppercase">ລຶບ</button>
                            </div>
                        </div>`).join('')}</div>
                    </div>`;
                });
            });
        }

        function filterMenu(cat) {
            currentCategory = cat;
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('bg-orange-500', 'text-white', 'shadow-md');
                btn.classList.add('text-slate-500');
                if(btn.innerText === cat) {
                    btn.classList.remove('text-slate-500');
                    btn.classList.add('bg-orange-500', 'text-white', 'shadow-md');
                }
            });
            renderMenus();
        }

        function openPOS(tableName) { currentTable = tableName; document.getElementById('pos-table-name').innerText = tableName; cart = activeOrders[tableName] ? activeOrders[tableName].items : []; renderCart(); showPage('page-pos'); }
        function renderAdminMenus() { document.getElementById('admin-display-list').innerHTML = allMenus.map(m => `<div class="flex justify-between items-center bg-slate-50 p-2 rounded-xl mb-1 text-[10px] font-bold"><span>${m.name}</span><button onclick="deleteMenu('${m.id}')" class="text-red-400 p-1"><i class="fas fa-trash-alt"></i></button></div>`).join(''); }
        async function deleteMenu(id) { if(confirm("ລຶບເມນູນີ້?")) await db.ref('menus/' + id).remove(); }
        async function deleteSale(id) { if(confirm("ລຶບປະຫວັດບິນ?")) await db.ref('sales/' + id).remove(); }

        loadMenus(); listenToOrders();
    </script>
</body>
</html>