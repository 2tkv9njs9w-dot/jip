<!DOCTYPE html>
<html lang="lo">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Khao Piak Jip Jip POS - Mobile Optimized</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Lao:wght@300;400;700&display=swap');
        body { font-family: 'Noto Sans Lao', sans-serif; background-color: #f8fafc; }
        .hidden { display: none !important; }
        .active-scale:active { transform: scale(0.95); }
        /* ‡ªÄ‡∫Æ‡∫±‡∫î‡ªÉ‡∫´‡ªâ‡ªú‡ªâ‡∫≤‡∫à‡ªç‡ªÄ‡∫•‡∫∑‡ªà‡∫≠‡∫ô‡ªÑ‡∫î‡ªâ‡ªÅ‡∫ï‡ªà‡∫ö‡ªç‡ªà‡ªÄ‡∫´‡∫±‡∫ô‡ªÅ‡∫ñ‡∫ö Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-50">

    <section id="page-login" class="flex items-center justify-center min-h-screen bg-orange-600 p-6">
        <div class="bg-white p-10 rounded-[2.5rem] shadow-2xl w-full max-w-sm text-center">
            <h1 class="text-2xl font-black text-slate-800 mb-8 uppercase italic">‡ªÄ‡∫Ç‡∫ª‡ªâ‡∫≤‡∫õ‡∫Ω‡∫Å‡∫à‡∫¥‡∫ö‡ªÜ</h1>
            <input type="password" id="login-pass" placeholder="‡∫•‡∫∞‡∫´‡∫±‡∫î‡∫ú‡ªà‡∫≤‡∫ô" class="w-full px-6 py-4 bg-slate-50 border-2 rounded-2xl text-center text-xl mb-4 outline-none">
            <button onclick="checkLogin()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-black active-scale">‡ªÄ‡∫Ç‡∫ª‡ªâ‡∫≤‡∫™‡∫π‡ªà‡∫•‡∫∞‡∫ö‡∫ª‡∫ö</button>
        </div>
    </section>

    <section id="page-table" class="hidden min-h-screen p-6 overflow-y-auto no-scrollbar">
        <div class="max-w-4xl mx-auto">
            <header class="flex justify-between items-center mb-8 sticky top-0 bg-slate-50 py-2 z-10">
                <h1 class="text-2xl font-black italic">‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡ªÇ‡∫ï‡∫∞</h1>
                <div class="flex gap-2">
                    <button onclick="showPage('page-report')" class="w-10 h-10 bg-white rounded-xl border flex items-center justify-center text-emerald-600 shadow-sm"><i class="fas fa-chart-line"></i></button>
                    <button onclick="showPage('page-admin')" class="w-10 h-10 bg-slate-900 rounded-xl flex items-center justify-center text-white shadow-lg"><i class="fas fa-plus"></i></button>
                </div>
            </header>
            <div id="table-grid" class="grid grid-cols-2 gap-4 pb-10">
                </div>
        </div>
    </section>

    <section id="page-pos" class="hidden min-h-screen flex flex-col overflow-hidden">
        <main class="flex-1 bg-slate-50 flex flex-col p-4 overflow-hidden">
            <header class="flex justify-between items-center mb-4">
                <button onclick="backToTable()" class="w-10 h-10 bg-white rounded-xl border active-scale"><i class="fas fa-arrow-left"></i></button>
                <div class="flex gap-1 bg-white p-1 rounded-xl border overflow-x-auto no-scrollbar">
                    <button onclick="filterMenu('‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î')" class="cat-btn px-4 py-2 rounded-lg font-black text-[10px] bg-orange-600 text-white">‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î</button>
                    <button onclick="filterMenu('‡∫≠‡∫≤‡∫´‡∫≤‡∫ô')" class="cat-btn px-4 py-2 rounded-lg font-black text-[10px] text-slate-400">‡∫≠‡∫≤‡∫´‡∫≤‡∫ô</button>
                    <button onclick="filterMenu('‡ªÄ‡∫Ñ‡∫∑‡ªà‡∫≠‡∫á‡∫î‡∫∑‡ªà‡∫°')" class="cat-btn px-4 py-2 rounded-lg font-black text-[10px] text-slate-400">‡ªÄ‡∫Ñ‡∫∑‡ªà‡∫≠‡∫á‡∫î‡∫∑‡ªà‡∫°</button>
                </div>
            </header>
            <div id="menu-list" class="grid grid-cols-2 gap-3 overflow-y-auto no-scrollbar pb-4"></div>
        </main>

        <aside class="h-[45vh] bg-white border-t rounded-t-[2.5rem] shadow-[0_-10px_40px_rgba(0,0,0,0.1)] flex flex-col z-20">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 id="pos-table-name" class="font-black italic">‡ªÇ‡∫ï‡∫∞...</h3>
                <span id="cart-count-badge" class="bg-orange-100 text-orange-600 px-3 py-1 rounded-lg text-[10px] font-black">0</span>
            </div>
            
            <div id="cart-items" class="flex-1 overflow-y-auto p-4 space-y-2 no-scrollbar"></div>

            <div class="p-6 bg-slate-50 border-t space-y-4">
                <div class="flex justify-between items-center">
                    <span class="text-slate-400 font-bold text-[10px]">‡∫•‡∫ß‡∫°‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î</span>
                    <h2 class="text-2xl font-black text-slate-900"><span id="total-price">0</span> <small class="text-xs text-orange-600">KIP</small></h2>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="saveCurrentOrder()" class="bg-slate-800 text-white py-4 rounded-2xl font-black active-scale text-xs">‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å</button>
                    <button onclick="checkout()" class="bg-orange-600 text-white py-4 rounded-2xl font-black active-scale text-lg">‡ªÑ‡∫•‡ªà‡ªÄ‡∫á‡∫¥‡∫ô</button>
                </div>
            </div>
        </aside>
    </section>

    <div id="toast" class="fixed bottom-20 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-8 py-3 rounded-full font-black text-xs hidden z-[300]"></div>

    <section id="page-admin" class="hidden min-h-screen bg-slate-100 p-6 overflow-y-auto no-scrollbar">
        <button onclick="showPage('page-table')" class="mb-4 text-slate-400"><i class="fas fa-arrow-left"></i> ‡∫Å‡∫±‡∫ö‡∫Ñ‡∫∑‡∫ô</button>
        <div class="bg-white p-6 rounded-3xl shadow-sm mb-6">
            <h2 class="text-xl font-black mb-4">‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡ªÄ‡∫°‡∫ô‡∫π</h2>
            <div class="space-y-3">
                <input type="text" id="admin-name" placeholder="‡∫ä‡∫∑‡ªà‡ªÄ‡∫°‡∫ô‡∫π" class="w-full p-4 border rounded-2xl outline-none">
                <input type="text" id="admin-price" placeholder="‡∫•‡∫≤‡∫Ñ‡∫≤ (‡ªÄ‡∫ä‡∫±‡ªà‡∫ô: 40000,45000,50000)" class="w-full p-4 border rounded-2xl outline-none">
                <select id="admin-category" class="w-full p-4 border rounded-2xl font-bold bg-white">
                    <option value="‡∫≠‡∫≤‡∫´‡∫≤‡∫ô">‡∫≠‡∫≤‡∫´‡∫≤‡∫ô</option>
                    <option value="‡ªÄ‡∫Ñ‡∫∑‡ªà‡∫≠‡∫á‡∫î‡∫∑‡ªà‡∫°">‡ªÄ‡∫Ñ‡∫∑‡ªà‡∫≠‡∫á‡∫î‡∫∑‡ªà‡∫°</option>
                </select>
                <button onclick="handleSaveMenu()" class="w-full bg-orange-600 text-white py-4 rounded-2xl font-black active-scale">‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡ªÄ‡∫°‡∫ô‡∫π</button>
            </div>
        </div>
        <div id="admin-display-list" class="space-y-2 pb-10"></div>
    </section>

    <section id="page-report" class="hidden min-h-screen bg-slate-50 p-6 overflow-y-auto no-scrollbar">
        <button onclick="showPage('page-table')" class="mb-4 text-slate-400"><i class="fas fa-arrow-left"></i> ‡∫Å‡∫±‡∫ö‡∫Ñ‡∫∑‡∫ô</button>
        <h2 class="text-xl font-black mb-6">‡∫•‡∫≤‡∫ç‡∫á‡∫≤‡∫ô</h2>
        <div id="report-summary" class="mb-6"></div>
        <div id="report-container" class="space-y-2 pb-10"></div>
    </section>

    <script>
        // --- ‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô FIREBASE (‡ªÉ‡∫ä‡ªâ‡ªÇ‡∫ï‡ªÄ‡∫î‡∫µ‡∫°‡∫Ç‡∫≠‡∫á‡ªÄ‡∫à‡∫ª‡ªâ‡∫≤) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDrkORCwmsdCsdpH81Y40kaDpgrHU-U6ps",
            authDomain: "khaopiakpos.firebaseapp.com",
            databaseURL: "https://khaopiakpos-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "khaopiakpos",
            storageBucket: "khaopiakpos.firebasestorage.app",
            messagingSenderId: "51654913004",
            appId: "1:51654913004:web:57eb6bc244c1918beaaec9"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let allMenus = [], cart = [], currentTable = "", currentCategory = "‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î", isChanged = false;

        // --- ‡∫•‡∫∞‡∫ö‡∫ª‡∫ö‡∫à‡∫±‡∫î‡∫Å‡∫≤‡∫ô‡ªú‡ªâ‡∫≤‡∫à‡ªç ---
        function showPage(id) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            if(id === 'page-table') listenTables();
            if(id === 'page-report') loadReports();
        }

        function checkLogin() {
            if(document.getElementById('login-pass').value === 'jip1234') showPage('page-table');
            else alert("‡∫•‡∫∞‡∫´‡∫±‡∫î‡∫ú‡∫¥‡∫î!");
        }

        function showToast(msg) {
            const t = document.getElementById("toast");
            t.innerText = msg; t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 1500);
        }

        // --- ‡∫•‡∫∞‡∫ö‡∫ª‡∫ö POS ---
        function renderMenus() {
            const container = document.getElementById('menu-list');
            const filtered = allMenus.filter(m => currentCategory === "‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î" || m.category === currentCategory);
            
            container.innerHTML = filtered.map(m => {
                const prices = String(m.price).split(',').map(p => parseInt(p.replace(/[^0-9]/g, '')) || 0);
                const isFood = m.category === '‡∫≠‡∫≤‡∫´‡∫≤‡∫ô';
                
                return `
                <div class="bg-white rounded-3xl border p-3 shadow-sm flex flex-col justify-between">
                    <h4 class="font-black text-[10px] mb-2 truncate uppercase text-slate-700">${m.name}</h4>
                    <div class="grid ${isFood ? 'grid-cols-1' : 'grid-cols-1'} gap-1">
                        ${isFood ? `
                            <div class="flex flex-col gap-1">
                                <button onclick="addToCart('${m.name}', ${prices[0]}, '‡∫ô‡ªâ‡∫≠‡∫ç')" class="bg-orange-50 text-orange-600 text-[9px] font-black py-2 rounded-xl active-scale border border-orange-100">‡∫ô‡ªâ‡∫≠‡∫ç (40k)</button>
                                <button onclick="addToCart('${m.name}', ${prices[1]||prices[0]}, '‡∫Å‡∫≤‡∫á')" class="bg-orange-50 text-orange-600 text-[9px] font-black py-2 rounded-xl active-scale border border-orange-100">‡∫Å‡∫≤‡∫á (45k)</button>
                                <button onclick="addToCart('${m.name}', ${prices[2]||prices[0]}, '‡ªÉ‡∫´‡∫ç‡ªà')" class="bg-orange-50 text-orange-600 text-[9px] font-black py-2 rounded-xl active-scale border border-orange-100">‡ªÉ‡∫´‡∫ç‡ªà (50k)</button>
                            </div>
                        ` : `
                            <button onclick="addToCart('${m.name}', ${prices[0]}, '‡∫õ‡∫ª‡∫Å‡∫Å‡∫∞‡∫ï‡∫¥')" class="bg-slate-900 text-white text-[10px] font-black py-3 rounded-xl active-scale">
                                ${prices[0].toLocaleString()} KIP
                            </button>
                        `}
                    </div>
                </div>`;
            }).join('');
        }

        function addToCart(name, price, size) {
            const numPrice = parseInt(price);
            const label = size === '‡∫õ‡∫ª‡∫Å‡∫Å‡∫∞‡∫ï‡∫¥' ? name : `${name} (${size})`;
            const foundIdx = cart.findIndex(i => i.name === label);
            if (foundIdx > -1) cart[foundIdx].qty++;
            else cart.push({ name: label, price: numPrice, qty: 1 });
            isChanged = true;
            updateCartUI();
        }

        function updateCartUI() {
            const container = document.getElementById('cart-items');
            let total = 0;
            container.innerHTML = cart.map((item, idx) => {
                total += (item.price * item.qty);
                return `
                <div class="bg-white p-3 rounded-2xl border flex justify-between items-center shadow-sm">
                    <div class="flex-1 pr-2">
                        <p class="font-black text-[10px] text-slate-800">${item.name}</p>
                        <p class="text-orange-600 font-bold text-[9px]">${item.price.toLocaleString()} KIP</p>
                    </div>
                    <div class="flex items-center gap-2 bg-slate-50 px-2 py-1 rounded-xl">
                        <button onclick="updateQty(${idx}, -1)" class="w-6 h-6 flex items-center justify-center text-slate-300"><i class="fas fa-minus text-[8px]"></i></button>
                        <span class="font-black text-[10px] w-4 text-center">${item.qty}</span>
                        <button onclick="updateQty(${idx}, 1)" class="w-6 h-6 flex items-center justify-center text-slate-900"><i class="fas fa-plus text-[8px]"></i></button>
                    </div>
                </div>`;
            }).join('');
            document.getElementById('total-price').innerText = total.toLocaleString();
            document.getElementById('cart-count-badge').innerText = cart.length;
        }

        function updateQty(idx, delta) {
            cart[idx].qty += delta;
            if (cart[idx].qty <= 0) cart.splice(idx, 1);
            isChanged = true;
            updateCartUI();
        }

        // --- ‡∫•‡∫∞‡∫ö‡∫ª‡∫ö‡∫≠‡∫±‡∫î‡∫ï‡∫∞‡ªÇ‡∫ô‡∫°‡∫±‡∫î: ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡ªÅ‡∫•‡ªâ‡∫ß‡∫Å‡∫±‡∫ö‡∫Ñ‡∫∑‡∫ô‡ªú‡ªâ‡∫≤‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡ªÇ‡∫ï‡∫∞ ---
        async function saveCurrentOrder() {
            if (!currentTable || cart.length === 0) return;
            await db.ref('activeOrders/' + currentTable).set({
                table: currentTable,
                items: cart,
                timestamp: Date.now()
            });
            isChanged = false;
            showToast("‚úÖ ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡ªÅ‡∫•‡ªâ‡∫ß");
            showPage('page-table'); // <--- ‡∫Å‡∫±‡∫ö‡ªÑ‡∫õ‡ªú‡ªâ‡∫≤‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡ªÇ‡∫ï‡∫∞‡∫≠‡∫±‡∫î‡∫ï‡∫∞‡ªÇ‡∫ô‡∫°‡∫±‡∫î
        }

        async function checkout() {
            if(cart.length === 0) return;
            const total = cart.reduce((s, i) => s + (i.price * i.qty), 0);
            if(confirm(`‡ªÑ‡∫•‡ªà‡ªÄ‡∫á‡∫¥‡∫ô ${currentTable}: ${total.toLocaleString()} KIP?`)) {
                await db.ref('sales').push({
                    table: currentTable,
                    total: total,
                    items: cart.map(i => `${i.name} x${i.qty}`).join(', '),
                    date: new Date().toLocaleDateString(),
                    timestamp: Date.now()
                });
                await db.ref('activeOrders/' + currentTable).remove();
                cart = []; isChanged = false;
                showToast("üí∞ ‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î");
                showPage('page-table'); // <--- ‡∫Å‡∫±‡∫ö‡ªÑ‡∫õ‡ªú‡ªâ‡∫≤‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡ªÇ‡∫ï‡∫∞‡∫≠‡∫±‡∫î‡∫ï‡∫∞‡ªÇ‡∫ô‡∫°‡∫±‡∫î
            }
        }

        function backToTable() { showPage('page-table'); }

        async function clearTable() {
            if(confirm("‡∫•‡∫∂‡∫ö‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î?")) {
                await db.ref('activeOrders/' + currentTable).remove();
                cart = []; isChanged = false;
                showPage('page-table');
            }
        }

        // --- ‡∫™‡ªà‡∫ß‡∫ô‡∫à‡∫±‡∫î‡∫Å‡∫≤‡∫ô‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô (Tables, Menus, Reports) ---
        function listenTables() {
            db.ref('activeOrders').on('value', snap => {
                const data = snap.val() || {};
                const grid = document.getElementById('table-grid');
                grid.innerHTML = '';
                for(let i=1; i<=20; i++) { // ‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡ªÄ‡∫õ‡∫±‡∫ô 20 ‡ªÇ‡∫ï‡∫∞‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡∫ó‡∫ª‡∫î‡∫™‡∫≠‡∫ö‡∫Å‡∫≤‡∫ô‡ªÄ‡∫•‡∫∑‡∫∑‡ªà‡∫≠‡∫ô
                    const name = `‡ªÇ‡∫ï‡∫∞ ${i}`;
                    const active = data[name];
                    grid.innerHTML += `
                    <div onclick="openPOS('${name}')" class="${active ? 'bg-orange-600 text-white shadow-xl scale-95' : 'bg-white text-slate-800'} p-8 rounded-[2rem] shadow-sm text-center font-black active-scale border transition-all">
                        <p class="text-lg italic uppercase">${name}</p>
                        <p class="text-[8px] opacity-50 mt-1">${active ? '‡∫°‡∫µ‡∫•‡∫π‡∫Å‡∫Ñ‡ªâ‡∫≤' : '‡∫ß‡ªà‡∫≤‡∫á'}</p>
                    </div>`;
                }
            });
        }

        function openPOS(name) {
            currentTable = name;
            document.getElementById('pos-table-name').innerText = name;
            db.ref('activeOrders/' + name).once('value', snap => {
                const d = snap.val();
                cart = (d && d.items) ? d.items : [];
                isChanged = false;
                updateCartUI();
                showPage('page-pos');
            });
        }

        function filterMenu(c) {
            currentCategory = c;
            document.querySelectorAll('.cat-btn').forEach(b => {
                const isMatch = b.innerText.includes(c);
                b.className = isMatch ? 'cat-btn px-4 py-2 rounded-lg font-black text-[10px] bg-orange-600 text-white shadow-md' : 'cat-btn px-4 py-2 rounded-lg font-black text-[10px] text-slate-400';
            });
            renderMenus();
        }

        async function handleSaveMenu() {
            const name = document.getElementById('admin-name').value;
            const price = document.getElementById('admin-price').value;
            const category = document.getElementById('admin-category').value;
            if(name && price) {
                const ref = db.ref('menus').push();
                await ref.set({ id: ref.key, name, price, category });
                document.getElementById('admin-name').value = '';
                document.getElementById('admin-price').value = '';
                showToast("‚úÖ ‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡ªÅ‡∫•‡ªâ‡∫ß");
            }
        }

        function loadReports() {
            db.ref('sales').on('value', snap => {
                const data = snap.val() || {};
                const sales = Object.values(data).sort((a,b) => b.timestamp - a.timestamp);
                const total = sales.reduce((acc, s) => acc + s.total, 0);
                document.getElementById('report-summary').innerHTML = `
                    <div class="bg-slate-900 p-6 rounded-3xl text-white shadow-lg">
                        <p class="text-[9px] font-black opacity-50 uppercase">‡∫ç‡∫≠‡∫î‡∫•‡∫ß‡∫°‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î</p>
                        <h2 class="text-2xl font-black italic text-orange-400">${total.toLocaleString()} KIP</h2>
                    </div>`;
                document.getElementById('report-container').innerHTML = sales.map(s => `
                    <div class="bg-white p-4 rounded-2xl border shadow-sm flex justify-between items-center text-[10px]">
                        <div><span class="font-black text-orange-600">${s.table}</span><br><span class="text-slate-400">${s.items}</span></div>
                        <div class="text-right font-black">${s.total.toLocaleString()}</div>
                    </div>`).join('');
            });
        }

        // --- ‡ªÄ‡∫•‡∫µ‡ªà‡∫°‡∫ï‡∫ª‡ªâ‡∫ô‡∫•‡∫∞‡∫ö‡∫ª‡∫ö ---
        db.ref('menus').on('value', snap => {
            const data = snap.val() || {};
            allMenus = Object.values(data);
            renderMenus();
            document.getElementById('admin-display-list').innerHTML = allMenus.map(m => `
                <div class="flex justify-between items-center bg-white p-3 rounded-2xl border text-[10px]">
                    <span class="font-black">${m.name}</span>
                    <button onclick="db.ref('menus/${m.id}').remove()" class="text-red-400"><i class="fas fa-trash"></i></button>
                </div>`).join('');
        });

        listenTables();
    </script>
</body>
</html>