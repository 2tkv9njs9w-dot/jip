<!DOCTYPE html>
<html lang="lo">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jip Jip POS - Mobile App Style</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Lao:wght@300;400;700&display=swap');
        body { font-family: 'Noto Sans Lao', sans-serif; background-color: #f8fafc; overflow: hidden; touch-action: manipulation; }
        .hidden { display: none !important; }
        .active-scale:active { transform: scale(0.95); transition: 0.1s; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Animation ສໍາລັບກະຕ່າທີ່ສະໄລ້ຂຶ້ນມາ */
        #cart-sheet { transition: transform 0.3s ease-in-out; transform: translateY(100%); }
        #cart-sheet.open { transform: translateY(0); }
        .overlay { background: rgba(0,0,0,0.5); opacity: 0; pointer-events: none; transition: 0.3s; }
        .overlay.show { opacity: 1; pointer-events: auto; }
    </style>
</head>
<body>

    <section id="page-login" class="fixed inset-0 bg-orange-600 flex items-center justify-center p-6 z-[100]">
        <div class="bg-white p-10 rounded-[3rem] w-full max-w-xs text-center shadow-2xl">
            <div class="w-20 h-20 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-6 text-orange-600 text-3xl">
                <i class="fas fa-store"></i>
            </div>
            <h1 class="text-xl font-black mb-6">ເຂົ້າປຽກຈິບໆ</h1>
            <input type="password" id="login-pass" placeholder="ລະຫັດຜ່ານ" class="w-full p-4 bg-slate-100 rounded-2xl mb-4 text-center outline-none border-2 border-transparent focus:border-orange-500">
            <button onclick="checkLogin()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-black active-scale">ເຂົ້າສູ່ລະບົບ</button>
        </div>
    </section>

    <section id="page-table" class="hidden fixed inset-0 flex flex-col p-6 overflow-hidden">
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-black italic">ເລືອກໂຕະ</h1>
            <div class="flex gap-2">
                <button onclick="showPage('page-report')" class="w-10 h-10 bg-white rounded-xl shadow-sm flex items-center justify-center text-emerald-500 border"><i class="fas fa-chart-pie"></i></button>
                <button onclick="showPage('page-admin')" class="w-10 h-10 bg-slate-900 rounded-xl shadow-lg flex items-center justify-center text-white"><i class="fas fa-cog"></i></button>
            </div>
        </header>
        <div id="table-grid" class="grid grid-cols-2 gap-4 overflow-y-auto no-scrollbar pb-10">
            </div>
    </section>

    <section id="page-pos" class="hidden fixed inset-0 flex flex-col bg-slate-50 overflow-hidden">
        <header class="bg-white p-4 flex justify-between items-center border-b shadow-sm">
            <div class="flex items-center gap-3">
                <button onclick="backToTable()" class="w-10 h-10 flex items-center justify-center text-slate-400 active-scale"><i class="fas fa-chevron-left text-xl"></i></button>
                <h2 id="pos-table-name" class="font-black text-lg italic uppercase">ໂຕະ 1</h2>
            </div>
            <div class="flex gap-1 bg-slate-100 p-1 rounded-xl">
                <button onclick="filterMenu('ທັງໝົດ')" class="cat-btn px-4 py-1.5 rounded-lg text-[10px] font-black bg-white shadow-sm">ທັງໝົດ</button>
                <button onclick="filterMenu('ອາຫານ')" class="cat-btn px-4 py-1.5 rounded-lg text-[10px] font-black text-slate-400">ອາຫານ</button>
                <button onclick="filterMenu('ເຄື່ອງດື່ມ')" class="cat-btn px-4 py-1.5 rounded-lg text-[10px] font-black text-slate-400">ເຄື່ອງດື່ມ</button>
            </div>
        </header>

        <div id="menu-list" class="flex-1 overflow-y-auto p-4 grid grid-cols-1 gap-4 no-scrollbar pb-24">
            </div>

        <div id="cart-bar" onclick="toggleCart()" class="fixed bottom-6 left-6 right-6 bg-slate-900 h-16 rounded-2xl flex items-center justify-between px-6 shadow-2xl z-40 active-scale cursor-pointer">
            <div class="flex items-center gap-3 text-white">
                <div class="relative">
                    <i class="fas fa-shopping-basket text-xl text-orange-400"></i>
                    <span id="cart-count-badge" class="absolute -top-2 -right-2 bg-white text-slate-900 text-[10px] font-black w-5 h-5 rounded-full flex items-center justify-center">0</span>
                </div>
                <div class="flex flex-col">
                    <span class="text-[8px] uppercase font-bold text-slate-400 leading-tight">ຍອດລວມ</span>
                    <span class="text-lg font-black leading-tight"><span id="total-price">0</span> KIP</span>
                </div>
            </div>
            <span class="text-white text-[10px] font-black border border-white/20 px-3 py-1 rounded-lg uppercase">ເບິ່ງອໍເດີ້</span>
        </div>

        <div id="cart-overlay" class="overlay fixed inset-0 z-[45]" onclick="toggleCart()"></div>
        <div id="cart-sheet" class="fixed bottom-0 left-0 right-0 bg-white rounded-t-[3rem] shadow-2xl z-[50] flex flex-col max-h-[85vh]">
            <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto my-4" onclick="toggleCart()"></div>
            <div class="px-6 py-2 flex justify-between items-center border-b">
                <h3 class="font-black text-lg italic">ລາຍການທີ່ສັ່ງ</h3>
                <button onclick="clearTable()" class="text-red-500 text-[10px] font-black uppercase">ລ້າງທັງໝົດ</button>
            </div>
            <div id="cart-items" class="flex-1 overflow-y-auto p-6 space-y-4 no-scrollbar">
                </div>
            <div class="p-8 bg-slate-50 border-t space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="saveCurrentOrder()" class="bg-slate-200 text-slate-800 py-4 rounded-2xl font-black active-scale text-xs">ບັນທຶກໄວ້</button>
                    <button onclick="checkout()" class="bg-orange-600 text-white py-4 rounded-2xl font-black active-scale text-lg">ໄລ່ເງິນ</button>
                </div>
            </div>
        </div>
    </section>

    <section id="page-admin" class="hidden fixed inset-0 bg-slate-100 p-6 overflow-y-auto no-scrollbar">
        <button onclick="showPage('page-table')" class="mb-6 font-bold text-slate-400"><i class="fas fa-arrow-left"></i> ກັບຄືນ</button>
        <div class="bg-white p-8 rounded-[2.5rem] shadow-sm mb-6">
            <h2 class="text-xl font-black mb-6 italic">ເພີ່ມເມນູໃໝ່</h2>
            <div class="space-y-4">
                <input type="text" id="admin-name" placeholder="ຊື່ເມນູ" class="w-full p-4 bg-slate-50 rounded-2xl outline-none">
                <input type="text" id="admin-price" placeholder="ລາຄາ (ເຊັ່ນ: 40000,45000,50000)" class="w-full p-4 bg-slate-50 rounded-2xl outline-none">
                <select id="admin-category" class="w-full p-4 bg-slate-50 rounded-2xl font-bold">
                    <option value="ອາຫານ">ອາຫານ</option>
                    <option value="ເຄື່ອງດື່ມ">ເຄື່ອງດື່ມ</option>
                </select>
                <button onclick="handleSaveMenu()" class="w-full bg-orange-600 text-white py-4 rounded-2xl font-black">ບັນທຶກ</button>
            </div>
        </div>
        <div id="admin-display-list" class="space-y-2 pb-10"></div>
    </section>

    <section id="page-report" class="hidden fixed inset-0 bg-white p-6 overflow-y-auto no-scrollbar">
        <button onclick="showPage('page-table')" class="mb-6 font-bold text-slate-400"><i class="fas fa-arrow-left"></i> ກັບຄືນ</button>
        <div id="report-summary" class="mb-6"></div>
        <div id="report-container" class="space-y-3 pb-10"></div>
    </section>

    <div id="toast" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-slate-900 text-white px-8 py-4 rounded-3xl font-black text-xs hidden z-[200] shadow-2xl text-center"></div>

    <script>
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDrkORCwmsdCsdpH81Y40kaDpgrHU-U6ps",
            authDomain: "khaopiakpos.firebaseapp.com",
            databaseURL: "https://khaopiakpos-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "khaopiakpos",
            storageBucket: "khaopiakpos.firebasestorage.app",
            messagingSenderId: "51654913004",
            appId: "1:51654913004:web:57eb6bc244c1918beaaec9"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let allMenus = [], cart = [], currentTable = "", currentCategory = "ທັງໝົດ", isChanged = false;

        // --- NAVIGATION ---
        function showPage(id) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            if(id === 'page-table') listenTables();
            if(id === 'page-report') loadReports();
        }

        function checkLogin() {
            if(document.getElementById('login-pass').value === 'jip1234') showPage('page-table');
            else alert("ລະຫັດບໍ່ຖືກ!");
        }

        function toggleCart() {
            const sheet = document.getElementById('cart-sheet');
            const overlay = document.getElementById('cart-overlay');
            sheet.classList.toggle('open');
            overlay.classList.toggle('show');
        }

        function showToast(msg) {
            const t = document.getElementById("toast");
            t.innerText = msg; t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 1200);
        }

        // --- RENDER MENU (Card Style) ---
        function renderMenus() {
            const container = document.getElementById('menu-list');
            const filtered = allMenus.filter(m => currentCategory === "ທັງໝົດ" || m.category === currentCategory);
            
            container.innerHTML = filtered.map(m => {
                const prices = String(m.price).split(',').map(p => parseInt(p.replace(/[^0-9]/g, '')) || 0);
                const isFood = m.category === 'ອາຫານ';

                return `
                <div class="bg-white rounded-[2rem] border p-5 shadow-sm flex flex-col gap-4">
                    <div class="flex justify-between items-start">
                        <h4 class="font-black text-slate-800 text-lg italic uppercase">${m.name}</h4>
                        <span class="text-[9px] font-black text-orange-500 bg-orange-50 px-3 py-1 rounded-full uppercase">${m.category}</span>
                    </div>
                    <div class="grid ${isFood ? 'grid-cols-3' : 'grid-cols-1'} gap-3">
                        ${isFood ? `
                            <button onclick="addToCart('${m.name}', ${prices[0]}, 'ນ້ອຍ')" class="flex flex-col items-center bg-slate-50 py-3 rounded-2xl active-scale border border-slate-100">
                                <span class="text-[9px] font-bold text-slate-400">ນ້ອຍ</span>
                                <span class="text-xs font-black">${(prices[0]/1000)}k</span>
                            </button>
                            <button onclick="addToCart('${m.name}', ${prices[1]||prices[0]}, 'ກາງ')" class="flex flex-col items-center bg-orange-50 py-3 rounded-2xl active-scale border border-orange-100">
                                <span class="text-[9px] font-bold text-orange-400">ກາງ</span>
                                <span class="text-xs font-black text-orange-600">${(prices[1]||prices[0])/1000}k</span>
                            </button>
                            <button onclick="addToCart('${m.name}', ${prices[2]||prices[0]}, 'ໃຫຍ່')" class="flex flex-col items-center bg-slate-50 py-3 rounded-2xl active-scale border border-slate-100">
                                <span class="text-[9px] font-bold text-slate-400">ໃຫຍ່</span>
                                <span class="text-xs font-black">${(prices[2]||prices[0])/1000}k</span>
                            </button>
                        ` : `
                            <button onclick="addToCart('${m.name}', ${prices[0]}, 'ປົກກະຕິ')" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-black active-scale text-sm">
                                ${prices[0].toLocaleString()} KIP
                            </button>
                        `}
                    </div>
                </div>`;
            }).join('');
        }

        // --- CART SYSTEM ---
        function addToCart(name, price, size) {
            const label = size === 'ປົກກະຕິ' ? name : `${name} (${size})`;
            const foundIdx = cart.findIndex(i => i.name === label);
            if (foundIdx > -1) cart[foundIdx].qty++;
            else cart.push({ name: label, price: parseInt(price), qty: 1 });
            isChanged = true;
            updateCartUI();
            showToast(`+ ${label}`);
        }

        function updateCartUI() {
            const container = document.getElementById('cart-items');
            let total = 0;
            container.innerHTML = cart.map((item, idx) => {
                total += (item.price * item.qty);
                return `
                <div class="flex justify-between items-center p-2">
                    <div class="flex-1">
                        <p class="font-black text-sm text-slate-800">${item.name}</p>
                        <p class="text-orange-600 font-bold text-xs">${item.price.toLocaleString()} KIP</p>
                    </div>
                    <div class="flex items-center gap-4 bg-slate-100 p-2 rounded-2xl">
                        <button onclick="updateQty(${idx}, -1)" class="w-8 h-8 flex items-center justify-center text-slate-400 active-scale"><i class="fas fa-minus"></i></button>
                        <span class="font-black text-sm w-4 text-center">${item.qty}</span>
                        <button onclick="updateQty(${idx}, 1)" class="w-8 h-8 flex items-center justify-center text-slate-900 active-scale"><i class="fas fa-plus"></i></button>
                    </div>
                </div>`;
            }).join('');
            document.getElementById('total-price').innerText = total.toLocaleString();
            document.getElementById('cart-count-badge').innerText = cart.length;
        }

        function updateQty(idx, delta) {
            cart[idx].qty += delta;
            if (cart[idx].qty <= 0) cart.splice(idx, 1);
            isChanged = true;
            updateCartUI();
        }

        // --- ACTIONS (ກັບຄືນໜ້າເລືອກໂຕະອັດຕະໂນມັດ) ---
        async function saveCurrentOrder() {
            if (!currentTable || cart.length === 0) return;
            await db.ref('activeOrders/' + currentTable).set({
                table: currentTable,
                items: cart,
                timestamp: Date.now()
            });
            isChanged = false;
            showToast("ບັນທຶກແລ້ວ!");
            showPage('page-table');
        }

        async function checkout() {
            if(cart.length === 0) return;
            const total = cart.reduce((s, i) => s + (i.price * i.qty), 0);
            if(confirm(`ໄລ່ເງິນ ${currentTable}: ${total.toLocaleString()} KIP?`)) {
                await db.ref('sales').push({
                    table: currentTable, total,
                    items: cart.map(i => `${i.name} x${i.qty}`).join(', '),
                    date: new Date().toLocaleDateString(),
                    timestamp: Date.now()
                });
                await db.ref('activeOrders/' + currentTable).remove();
                cart = []; isChanged = false;
                showToast("ຊຳລະເງິນສຳເລັດ!");
                showPage('page-table');
            }
        }

        function backToTable() { showPage('page-table'); }

        async function clearTable() {
            if(confirm("ລຶບລາຍການທັງໝົດໃນໂຕະນີ້?")) {
                await db.ref('activeOrders/' + currentTable).remove();
                cart = []; isChanged = false;
                toggleCart();
                showPage('page-table');
            }
        }

        // --- FIREBASE LISTENERS ---
        function listenTables() {
            db.ref('activeOrders').on('value', snap => {
                const data = snap.val() || {};
                const grid = document.getElementById('table-grid');
                grid.innerHTML = '';
                for(let i=1; i<=20; i++) {
                    const name = `ໂຕະ ${i}`;
                    const active = data[name];
                    grid.innerHTML += `
                    <div onclick="openPOS('${name}')" class="${active ? 'bg-orange-600 text-white shadow-xl scale-95' : 'bg-white text-slate-800 border-slate-100'} p-8 rounded-[2.5rem] shadow-sm text-center font-black active-scale border transition-all">
                        <p class="text-lg italic tracking-tighter uppercase">${name}</p>
                        <p class="text-[8px] uppercase opacity-50 mt-1">${active ? 'ມີລູກຄ້າ' : 'ວ່າງ'}</p>
                    </div>`;
                }
            });
        }

        function openPOS(name) {
            currentTable = name;
            document.getElementById('pos-table-name').innerText = name;
            db.ref('activeOrders/' + name).once('value', snap => {
                const d = snap.val();
                cart = (d && d.items) ? d.items : [];
                isChanged = false;
                updateCartUI();
                showPage('page-pos');
            });
        }

        function filterMenu(c) {
            currentCategory = c;
            document.querySelectorAll('.cat-btn').forEach(b => {
                const isMatch = b.innerText.includes(c);
                b.className = isMatch ? 'cat-btn px-4 py-1.5 rounded-lg text-[10px] font-black bg-slate-900 text-white shadow-lg' : 'cat-btn px-4 py-1.5 rounded-lg text-[10px] font-black text-slate-400';
            });
            renderMenus();
        }

        db.ref('menus').on('value', snap => {
            allMenus = snap.val() ? Object.values(snap.val()) : [];
            renderMenus();
            document.getElementById('admin-display-list').innerHTML = allMenus.map(m => `
                <div class="flex justify-between items-center bg-white p-4 rounded-2xl border mb-2">
                    <span class="text-[10px] font-black">${m.name}</span>
                    <button onclick="db.ref('menus/${m.id}').remove()" class="text-red-400 p-2"><i class="fas fa-trash-alt"></i></button>
                </div>`).join('');
        });

        async function handleSaveMenu() {
            const name = document.getElementById('admin-name').value;
            const price = document.getElementById('admin-price').value;
            const category = document.getElementById('admin-category').value;
            if(name && price) {
                const ref = db.ref('menus').push();
                await ref.set({ id: ref.key, name, price, category });
                document.getElementById('admin-name').value = '';
                document.getElementById('admin-price').value = '';
                showToast("ເພີ່ມສຳເລັດ!");
            }
        }

        function loadReports() {
            db.ref('sales').on('value', snap => {
                const data = snap.val() || {};
                const sales = Object.values(data).sort((a,b) => b.timestamp - a.timestamp);
                const total = sales.reduce((acc, s) => acc + s.total, 0);
                document.getElementById('report-summary').innerHTML = `
                    <div class="bg-slate-900 p-8 rounded-[2.5rem] text-white shadow-2xl">
                        <p class="text-[10px] font-black uppercase text-orange-400 mb-2">ຍອດຂາຍທັງໝົດ</p>
                        <h2 class="text-3xl font-black italic">${total.toLocaleString()} KIP</h2>
                    </div>`;
                document.getElementById('report-container').innerHTML = sales.map(s => `
                    <div class="bg-slate-50 p-5 rounded-2xl border flex justify-between items-center">
                        <div class="text-left">
                            <span class="bg-orange-100 text-orange-600 px-3 py-1 rounded-full text-[8px] font-black">${s.table}</span>
                            <p class="text-[9px] text-slate-500 mt-2 font-bold">${s.items}</p>
                        </div>
                        <p class="font-black text-slate-900 text-sm">${s.total.toLocaleString()}</p>
                    </div>`).join('');
            });
        }

        listenTables();
    </script>
</body>
</html>